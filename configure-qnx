#!/bin/sh
#
# configure-qnx (x86_64 only)

F="configure-qnx"

if test "$*" = "--help" -o "$*" = "-h"; then
  echo "$F [OPTIONS]"
  echo ""
  echo "OPTIONS     Other options that will be passed directly to"
  echo "            ./configure script. Run ./configure --help"
  echo "            for more info."
  exit 0
fi

# Set x86_64 target
TARGET_ARCH="x86_64"
TARGET_ARCHEND="${TARGET_ARCH}"
LIBDIR="${TARGET_ARCH}"
TARGET_HOST="x86_64-pc-nto-qnx7.1.0"

# Set toolchain paths
RANLIB="${QNX_HOST}/usr/bin/nto${TARGET_ARCH}-ranlib"
CPP="${QNX_HOST}/usr/bin/qcc"
CC="${QNX_HOST}/usr/bin/qcc"
LD="${QNX_HOST}/usr/bin/nto${TARGET_ARCH}-ld"

# Set linker flags
export LDFLAGS="$LDFLAGS -L${QNX_TARGET}/${LIBDIR}/usr/lib -L${QNX_TARGET}/${LIBDIR}/lib -L${QNX_HOST}/usr/lib/gcc/${TARGET_HOST}/4.6.3 -lgcc -lasound"

# Set compiler flags
if test "$CFLAGS" = ""; then
  export CFLAGS=" -g -O2"
fi
export CFLAGS="$CFLAGS -fPIC -DPJ_QNX=1 -DPJ_CONFIG_QNX=1 -DPJMEDIA_AUDIO_DEV_HAS_QNX=1 -Wno-int-to-pointer-cast"
export CFLAGS="$CFLAGS -DWEBRTC_DISABLE_CPU_DETECTION"
export CFLAGS="$CFLAGS -I${QNX_TARGET}/usr/include"


# Run configure
./configure --host=${TARGET_HOST} --host=x86_64-pc-nto-qnx7.1.0  LD=q++ --disable-libwebrtc --prefix=$HOME/qnx_pjsip "$@"
RETVAL=$?

# Write to pjsip.pri only if configure was successful
if test $RETVAL -eq 0; then
  echo "# Config file to be included in app's .pro file" > pjsip.pri
  echo "# Auto-generated by 'configure-qnx $*'" >> pjsip.pri
  make -f qnx-config.mak >> pjsip.pri

  echo "PJSIP config file for QNX has been written to 'pjsip.pri'. You can include this file from your application's .pro file."
  echo
fi
